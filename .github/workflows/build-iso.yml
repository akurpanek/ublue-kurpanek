name: Build ISO from UBlue Image

on:
  workflow_dispatch:
    inputs:
      image-name:
        description: "Name des BlueBuild/Bluefin Images"
        default: "kurpanek-silverblue"
        required: true
      image-tag:
        description: "Tag des Images"
        default: "latest"
        required: true
      iso-name:
        description: "ISO-Dateiname"
        default: "kurpanek-silverblue.iso"
        required: true

env:
  IMAGE_NAME: ${{ inputs.image-name }}
  IMAGE_TAG: ${{ inputs.image-tag }}
  ISO_NAME: ${{ inputs.iso-name }}
  OUTPUT_DIR: iso-output

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y podman curl jq build-essential pkg-config libssl-dev

      - name: Install Rust (required for BlueBuild CLI)
        uses: dtolnay/rust-toolchain@stable

      - name: Install BlueBuild CLI (cargo)
        run: |
          cargo install blue-build
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          bluebuild --version

      - name: Pull published BlueBuild image
        run: |
          podman pull ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}

      - name: Create ISO output directory
        run: mkdir -p "${OUTPUT_DIR}"

      - name: Generate ISO (BlueBuild official way)
        run: |
          bluebuild generate-iso \
            --iso-name "${ISO_NAME}" \
            image ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}

          mv "${ISO_NAME}" "${OUTPUT_DIR}/${ISO_NAME}"

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ env.OUTPUT_DIR }}/${{ env.ISO_NAME }}
