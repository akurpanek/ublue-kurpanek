name: Build ISO from UBlue Image

on:
  workflow_run:
    workflows: ["build-kurpanek-ublue"]
    types:
      - completed
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ublue-os/bluefin:latest
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo dnf install -y lorax-composer lorax-templates-generic

      - name: Download the built image artifact
        uses: actions/download-artifact@v4
        with:
          name: ublue-image
          path: ./artifacts

      - name: Generate ISO
        run: |
          # Setze den Pfad zur heruntergeladenen Image-Datei
          IMAGE_PATH=$(ls ./artifacts/*.raw.xz | head -n 1)
          if [ -z "$IMAGE_PATH" ]; then
            echo "Keine Image-Datei gefunden!"
            exit 1
          fi

          # Entpacke die Image-Datei
          unxz "$IMAGE_PATH"
          IMAGE_PATH="${IMAGE_PATH%.xz}"

          # Erstelle ein temporäres Verzeichnis für die ISO-Erstellung
          mkdir -p /tmp/iso

          # Erstelle die ISO mit lorax-composer
          sudo composer-cli compose start --arg distro "bluefin" --arg image_name "bluefin-iso" --arg image_desc "Bluefin ISO" --arg image_version "1.0" --arg base_image "$IMAGE_PATH" bluefin-iso qcow2

          # Warte, bis die ISO erstellt wurde
          sudo composer-cli compose status

          # Lade die erstellte ISO herunter
          sudo composer-cli compose metadata bluefin-iso > compose-metadata.json
          ISO_PATH=$(jq -r '.image_builds[0].paths[0]' compose-metadata.json)
          mv "$ISO_PATH" ./bluefin.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: bluefin-iso
          path: ./bluefin.iso
