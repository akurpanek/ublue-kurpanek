name: Build ISO from UBlue Image

on:
  workflow_dispatch:
    inputs:
      image-name:
        description: "Name des BlueBuild/Bluefin Images"
        default: "kurpanek-silverblue"
        required: true
      image-tag:
        description: "Tag des Images"
        default: "latest"
        required: true
      iso-name:
        description: "ISO-Dateiname"
        default: "kurpanek-silverblue.iso"
        required: true

env:
  IMAGE_NAME: ${{ inputs.image-name }}
  IMAGE_TAG: ${{ inputs.image-tag }}
  ISO_NAME: ${{ inputs.iso-name }}
  OUTPUT_DIR: iso-output

permissions:
  packages: write
  contents: read
  
jobs:
  build-iso:
    runs-on: ubuntu-latest    

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y podman curl jq build-essential pkg-config libssl-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install BlueBuild CLI
        run: |
          cargo install blue-build
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Pull published image
        run: |
          podman pull ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}

      - name: Create output dir
        run: mkdir -p "${OUTPUT_DIR}"

      - name: Generate ISO
        run: |
          bluebuild generate-iso \
            --iso-name "${ISO_NAME}" \
            image ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}
          mv "${ISO_NAME}" "${OUTPUT_DIR}/${ISO_NAME}"

      - name: Upload ISO as CI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ env.OUTPUT_DIR }}/${{ env.ISO_NAME }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "iso-${{ env.IMAGE_TAG }}"
          name: "ISO Release (${{ env.IMAGE_TAG }})"
          files: ${{ env.OUTPUT_DIR }}/${{ env.ISO_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
