name: Build ISO from UBlue Image

on:
  workflow_dispatch:
    inputs:
      image-name:
        description: "Name des BlueBuild/Bluefin Images"
        default: "kurpanek-silverblue"
        required: true
      image-tag:
        description: "Tag des Images"
        default: "latest"
        required: true
      iso-name:
        description: "ISO-Dateiname"
        default: "kurpanek-silverblue.iso"
        required: true

env:
  IMAGE_NAME: ${{ inputs.image-name }}
  IMAGE_TAG: ${{ inputs.image-tag }}
  ISO_NAME: ${{ inputs.iso-name }}
  OUTPUT_DIR: iso-output

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies (Podman + tools)
        run: |
          sudo apt-get update
          sudo apt-get install -y podman curl jq

      - name: Install official BlueBuild CLI
        run: |
          curl -L https://raw.githubusercontent.com/blue-build/bluebuild/main/install.sh | bash
          echo "$HOME/.bluebuild/bin" >> $GITHUB_PATH

      - name: Export environment variables for shell
        run: |
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "ISO_NAME=${ISO_NAME}" >> $GITHUB_ENV
          echo "OUTPUT_DIR=${OUTPUT_DIR}" >> $GITHUB_ENV

      - name: Pull published BlueBuild image
        run: |
          podman pull ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}

      - name: Create ISO output directory
        run: mkdir -p "${OUTPUT_DIR}"

      - name: Generate ISO (BlueBuild official way)
        run: |
          export PATH="$HOME/.bluebuild/bin:$PATH"

          bluebuild generate-iso \
            --iso-name "${ISO_NAME}" \
            image ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}

          mv "${ISO_NAME}" "${OUTPUT_DIR}/${ISO_NAME}"

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ env.OUTPUT_DIR }}/${{ env.ISO_NAME }}
